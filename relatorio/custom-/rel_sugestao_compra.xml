<?xml version='1.0' encoding='iso8859-1'?>
<relatorio ts="2008-08-18 14:52:11" versao_xml="0.1"><tela titulo=" x">
  <quadro titulo="Parâmetros">
    <campo id="data_ini" requerido="sim" tipo="data" titulo="Data" valor_padrao="select current_date" />
    <procura condicao="(case when (select grid from empresa_local limit 1) is null then true else codigo in (select codigo from deposito where empresa = (select grid from empresa_local limit 1)) end)" id="deposito" modelo="deposito" titulo="Depósito" />
    <procura id="grupo" modelo="grupo_produto" titulo="Grupo Produto" />
    <procura id="subgrupo" modelo="subgrupo_produto" titulo="SubGrupo" />
    <procura id="produto" modelo="produto" titulo="Produto" />
    <caixa titulo="Opções">
      <selecao id="sugerir" origem="VALUES (0,&apos;Estoque Minimo&apos;),(1,&apos;Estoque Padrao&apos;),(2,&apos;Estoque Maximo&apos;)" requerido="sim" titulo="Sugerir" />
    </caixa>
  </quadro>
</tela><ajuda>&lt;big&gt;&lt;b&gt;Relatorio de Sugestão de Compra&lt;/b&gt;&lt;/big&gt;

Este relatório permite ver a Sugestão de Compra</ajuda><layout dados="select 
     p.grid, 
     p.codigo as produto_codigo, 
     p.nome as produto_nome, 
     p.preco_unit as preco_venda, 
     gp.codigo||&apos; - &apos;||gp.nome as grupo_cod_nome, 
     pd.est_minimo, 
     pd.est_padrao, 
     pd.est_maximo, 
     d.empresa, 
     pe.codigo||&apos; - &apos;||pe.nome as empresa_cod_nome, 
     (select l.data from lancto l where l.operacao=&apos;E&apos; and l.produto=p.grid and data&lt;=$data_ini order by l.data desc, l.seq desc limit 1) as data_ult_compra, 
     (select l.preco_unit from lancto l where l.operacao=&apos;E&apos; and l.produto=p.grid and data&lt;=$data_ini order by l.data desc, l.seq desc limit 1) as preco_ult_compra, 
     (case when $sugerir = 0 then &apos;Minimo&apos; else (case when $sugerir = 1 then &apos;Padrao&apos; else &apos;Maximo&apos; end) end) as tipo_estoque 
from 
     produto p 
          join grupo_produto gp on (gp.grid = p.grupo) 
          join deposito d on (d.grid in(select dgp.deposito from deposito_grupo_produto dgp where dgp.grupo= p.grupo)) 
          join produto_deposito pd on (pd.produto = p.grid and pd.deposito = d.grid) 
          join lancto l on (l.produto = p.grid) 
          left join pessoa pe on (pe.grid = d.empresa) 
where 
     (case when(select grid from empresa_local limit 1) is null then true else d.empresa in(select grid from empresa_local limit 1) end)  
and (case when $grupo is null then true else gp.grid = $grupo end)  
and (case when $subgrupo is null then true else p.subgrupo = $subgrupo end)  
and (case when $produto is null then true else p.grid = $produto end)  
and (case when $deposito is null then true else d.grid = $deposito end)  
and l.operacao=&apos;E&apos;  
and l.data &lt;= $data_ini /*and p.tipo=&apos;S&apos;*/ 
group by 
     p.grid, 
     p.codigo, 
     p.nome, 
     p.preco_unit, 
     gp.codigo||&apos; - &apos;||gp.nome, 
     pd.est_minimo, 
     pd.est_padrao, 
     pd.est_maximo, 
     d.empresa, 
     pe.codigo||&apos; - &apos;||pe.nome 
order by 
     10, 
     5, 
     3
" id="4926af86b780ec1532e27002f617f068" ordem=" " titulo="Sugestão de Compra"><apelidos>1  rel_posto_nome	tam=60
2  rel_data_hora        tam=18
3  titulo1		tam=120			alinha=centro
4  titulo2		tam=120			alinha=centro
5  empresa_cod_nome	tam=50
6  grupo_cod_nome	tam=50
7  tipo_estoque		tam=8			alinha=direita
8  produto_codigo	tam=13
9  produto_nome		tam=30
10 estoque		tam=9  	fmt=%.01f
11 data_ult_compra	tam=10	fmt=data
12 preco_ult_compra     tam=8 	fmt=%.03f	alinha=direita
13 pessoa_codigo	tam=10			alinha=direita
14 estoque_base		tam=8	fmt=%.01f
15 necessidade		tam=8	fmt=%.01f
16 preco_venda		tam=10  fmt=%.02f
17 titulo3		tam=120 		alinha=centro</apelidos><cab_pagina>
#1                                                                                                       #2
-------------------------------------------------------------------------------------------------------------------------

#3
#4

</cab_pagina>

<cab_grupo nome="1" quebra="empresa_cod_nome" quebra_pagina="1" repeticao="0">
EMPRESA: #5
</cab_grupo>

<cab_grupo nome="2" quebra="empresa_cod_nome,grupo_cod_nome">
+-----------------------------------------------------------------------------------------------------------------------+
| GRUPO: #6                                                                                                             |
+---------------+--------------------------------+-----------+------------+----------+------------+----------+----------+
| Código        | Produto                        | Est Atual | Ult.Compra | Pr.Custo |   Pr.Venda | #7       | Sugestão |
+---------------+--------------------------------+-----------+------------+----------+------------+----------+----------+
</cab_grupo>

<detalhe>
| #8            | #9                             | #10       | #11        | #12      | #16        | #14      | #15      |
</detalhe>

<rod_grupo nome="2">
+---------------+--------------------------------+-----------+------------+----------+------------+----------+----------+

</rod_grupo>

<rod_grupo nome="1">
</rod_grupo>

<rod_pagina>
+---------------+--------------------------------+-----------+------------+----------+------------+----------+----------+
</rod_pagina>
</layout></relatorio>