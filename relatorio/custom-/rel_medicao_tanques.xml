<?xml version='1.0' encoding='iso8859-1'?>
<relatorio ts="2009-02-12 10:30:20" versao_xml="0.1">
  <tela titulo="Medição de Tanques">
  <quadro titulo="Parâmetros">
    <procura id="empresa" modelo="empresa" titulo="Empresa" valor_padrao="select empresa from empresa_local limit 1" />
    <campo id="data" requerido="sim" tipo="data" titulo="Data" valor_padrao="select current_date" />
  </quadro>
</tela>
  <ajuda>&lt;big&gt;&lt;b&gt;Relatorio de Medição de Tanques&lt;/b&gt;&lt;/big&gt;

Este relatório permite ver as Medição de Tanques</ajuda>
  <layout dados="select distinct d.grid as grid, d.codigo as tanque, p.nome as combustivel, pessoa_nome(d.empresa) as empresa, lc.data as data_metragem, $data::date as data, (select l.data from lancto l, produto p, deposito d where operacao=&apos;M&apos; and (case when $empresa is null then true else l.empresa=lc.empresa end) and l.deposito = d.grid and d.produto = p.grid and l.data::date &lt; lc.data::date order by l.data desc, p.codigo limit 1) as data_anterior, coalesce((select l.valor from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data = (select la.data from lancto la, produto pd, deposito dd where operacao=&apos;M&apos; and (case when $empresa is null then true else la.empresa=lc.empresa end) and la.deposito = dd.grid and dd.produto = pd.grid and la.data::date &lt; lc.data::date order by la.data desc, la.hora desc, pd.codigo limit 1)),0) as medicao_ant, coalesce((select l.quantidade from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data = (select la.data from lancto la, produto pd, deposito dd where operacao=&apos;M&apos; and (case when $empresa is null then true else la.empresa=lc.empresa end) and la.deposito = dd.grid and dd.produto = pd.grid and la.data::date &lt; lc.data::date order by la.data desc, la.hora desc, pd.codigo limit 1)),0) as litragem_ant, coalesce((select l.valor from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data::date = lc.data::date order by l.hora desc limit 1), 0) as medicao_atual, coalesce((select l.quantidade from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data::date = lc.data::date order by l.hora desc limit 1), 0) as litragem_atual, coalesce((select sum(l.quantidade) from lancto l where l.empresa=d.empresa and (l.operacao=&apos;E&apos; or l.operacao=&apos;TE&apos;) and l.deposito=d.grid and (l.data::date = $data::date)), 0) as entrada, coalesce((select sum(l.quantidade) from lancto l where l.empresa=d.empresa and (l.operacao=&apos;V&apos; or l.operacao=&apos;TS&apos;) and l.deposito=d.grid and (l.data::date = $data::date)), 0) as bombas, coalesce((select sum(l.quantidade) from lancto l where l.empresa=d.empresa and (l.operacao=&apos;E&apos; or l.operacao=&apos;TE&apos;) and l.deposito=d.grid and l.data = lc.data) + (select l.quantidade from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data = lc.data order by l.hora limit 1), 0) as estoque, (coalesce(coalesce((select sum(l.quantidade) from lancto l where l.empresa=d.empresa and (l.operacao=&apos;E&apos; or l.operacao=&apos;TE&apos;) and l.deposito=d.grid and l.data = $data), 0) + coalesce((select l.quantidade from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data = (select l.data from lancto l, produto pd, deposito dd where operacao=&apos;M&apos; and (case when $empresa is null then true else l.empresa=lc.empresa end) and l.deposito = dd.grid and dd.produto = pd.grid and l.data::date &lt; lc.data::date order by l.data desc, pd.codigo limit 1)), 0),0) - (select l.quantidade from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data = lc.data limit 1)) as saida from deposito d, produto p, lancto lc where d.produto=p.grid and lc.deposito=d.grid and (case when $empresa is null then true else d.empresa=$empresa end) and lc.produto = p.grid and (lc.data = (select l.data from lancto l, produto p, deposito d where operacao=&apos;M&apos; and (case when $empresa is null then true else l.empresa=$empresa end) and l.deposito = d.grid and d.produto = p.grid and l.data &lt;= $data order by l.data desc, p.codigo limit 1)) order by 2, 3 " id="b1df05a834bc38ee330fd7113bb63555" ordem=" " paper_orientation="1" titulo="Medição de Tanques">
    <apelidos>1  rel_posto_nome	tam=50
2  rel_data_hora	tam=18
3  empresa          	tam=50
5  tanque	        tam=5	alinha=esquerda
6  combustivel		tam=20
7  data_metragem    	tam=10	fmt=data
8  medicao_ant		tam=3	fmt=%.0f
9  litragem_ant		tam=8 	fmt=%.01f
10 entrada 		tam=8	fmt=%.01f
11 estoque		tam=8	fmt=%.01f	expr=entrada+litragem_ant
12 medicao_atual	tam=3	fmt=%.0f
13 litragem_atual   	tam=8  	fmt=%.01f
14 saida		tam=8  	fmt=%.01f
15 bombas           	tam=8  	fmt=%.01f
16 diferenca        	tam=8  	fmt=%.01f	expr=bombas-saida
17 acumulado        	tam=8  	fmt=%.01f	func=soma 	campo=diferenca	grupo=1
18 tot_ite_saida        tam=9  	fmt=%.01f	func=soma 	campo=saida	grupo=1
19 tot_ite_bomba        tam=9  	fmt=%.01f	func=soma 	campo=bombas	grupo=1
20 tot_ite_difer        tam=9  	fmt=%.01f	func=soma 	campo=diferenca	grupo=1
21 tot_ite_acum         tam=9  	fmt=%.01f
22 tot_ger_saida        tam=9  	fmt=%.01f	func=soma 	campo=saida
23 tot_ger_bomba        tam=9  	fmt=%.01f	func=soma 	campo=bombas
24 tot_ger_difer        tam=9  	fmt=%.01f	func=soma 	campo=diferenca
25 tot_ger_acum         tam=9  	fmt=%.01f
30 data			tam=10	fmt=data</apelidos>
    <cab_pagina>
#1                                                                                                #2
------------------------------------------------------------------------------------------------------------------

                                   MEDIÇÕES DE TANQUE - Data: #30           

</cab_pagina>
    <cab_grupo nome="1" quebra="empresa">
+----------------------------------------------------------------------------------------------------------------+
| Empresa: #3                                                                                                    |
+--------------------------+----------------+---------+---------+----------------+---------+---------+-----------+
|                          |    Inicial     |         |         |     Final      |   Saida |   Saida |           |
| TQ | Combustivel         | Med | Litragem | Entrada | Estoque | Med | Litragem |  Bombas |  Tanque | Diferença |
+--------------------------+-----+----------+---------+---------+-----+----------+---------+---------+-----------+
</cab_grupo>
    <detalhe>
|#5  | #6                  | #8  | #9       |#10      |#11      | #12 | #13      |#15      |#14      |  #16      |
</detalhe>
    <rod_grupo nome="1">
+--------------------------+-----+----------+---------+---------+-----+----------+---------+---------+-----------+
|                                                    Total Geral do Tanque       |#19      |#18      | #20       |
+--------------------------------------------------------------------------------+---------+---------+-----------+

</rod_grupo>
    <rod_relat>
+--------------------------------------------------------------------------------+---------+---------+-----------+
|                                                   Total Geral da Empresa       |#23      |#22      | #24       |
+--------------------------------------------------------------------------------+---------+---------+-----------+
</rod_relat>
    <rod_pagina>
+--------------------------+-----+----------+---------+---------+-----+----------+---------+---------+-----------+
</rod_pagina>
    </layout>
    <layout dados="select s.* from (select distinct d.grid as grid, d.codigo as tanque, p.grid as produto, p.nome as combustivel, pessoa_nome(d.empresa) as empresa, lc.data as data_metragem, coalesce((select l.valor from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data = (select la.data from lancto la, produto pd, deposito dd where operacao=&apos;M&apos; and (case when $empresa is null then true else la.empresa=lc.empresa end) and la.deposito = dd.grid and dd.produto = pd.grid and la.data::date &lt; lc.data::date order by la.data desc, la.hora desc, pd.codigo limit 1)),0) as medicao_ant, coalesce((select l.quantidade from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data = (select la.data from lancto la, produto pd, deposito dd where operacao=&apos;M&apos; and (case when $empresa is null then true else la.empresa=lc.empresa end) and la.deposito = dd.grid and dd.produto = pd.grid and la.data::date &lt; lc.data::date order by la.data desc, la.hora desc, pd.codigo limit 1)),0) as litragem_ant, coalesce((select l.valor from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data::date = lc.data::date order by l.hora desc limit 1), 0) as medicao_atual, coalesce((select l.quantidade from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data::date = lc.data::date order by l.hora desc limit 1), 0) as litragem_atual, coalesce((select sum(l.quantidade) from lancto l where l.empresa=d.empresa and (l.operacao=&apos;E&apos; or l.operacao=&apos;TE&apos;) and l.deposito=d.grid and (l.data::date = $data::date)), 0) as entrada, coalesce((select sum(l.quantidade) from lancto l where l.empresa=d.empresa and (l.operacao=&apos;V&apos; or l.operacao=&apos;TS&apos;) and l.deposito=d.grid and (l.data::date = $data::date)), 0) as bombas, coalesce((select sum(l.quantidade) from lancto l where l.empresa=d.empresa and (l.operacao=&apos;E&apos; or l.operacao=&apos;TE&apos;) and l.deposito=d.grid and l.data = lc.data) + (select l.quantidade from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data = lc.data order by l.hora limit 1), 0) as estoque, (coalesce(coalesce((select sum(l.quantidade) from lancto l where l.empresa=d.empresa and (l.operacao=&apos;E&apos; or l.operacao=&apos;TE&apos;) and l.deposito=d.grid and l.data = $data), 0) + coalesce((select l.quantidade from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data = (select l.data from lancto l, produto pd, deposito dd where operacao=&apos;M&apos; and (case when $empresa is null then true else l.empresa=lc.empresa end) and l.deposito = dd.grid and dd.produto = pd.grid and l.data::date &lt; lc.data::date order by l.data desc, pd.codigo limit 1)), 0),0) - (select l.quantidade from lancto l where l.empresa=d.empresa and l.operacao=&apos;M&apos; and l.deposito=d.grid and l.data = lc.data limit 1)) as saida from deposito d, produto p, lancto lc where d.produto=p.grid and lc.deposito = d.grid and (case when $empresa is null then true else d.empresa=$empresa end) and lc.produto = p.grid and (lc.data = (select l.data from lancto l, produto p, deposito d where operacao=&apos;M&apos; and (case when $empresa is null then true else l.empresa=$empresa end) and l.deposito = d.grid and d.produto = p.grid and l.data &lt;= $data order by l.data desc, p.codigo limit 1)) ) as s order by s.empresa, s.combustivel, s.produto " id="2717f3576ef026740077646bad32a7a1" ordem=" " paper_orientation="1" titulo="Medição de Tanques com agrupamento por produto">
    <apelidos>1  rel_posto_nome		tam=50
2  rel_data_hora		tam=18
3  empresa			tam=50
5  tanque			tam=5	alinha=esquerda
6  combustivel			tam=20
7  data_metragem		tam=10	fmt=data
8  medicao_ant			tam=3	fmt=%.0f
9  litragem_ant			tam=8	fmt=%.01f
10 entrada 			tam=8	fmt=%.01f
11 estoque			tam=8	fmt=%.01f	expr=entrada+litragem_ant
12 medicao_atual		tam=3	fmt=%.0f
13 litragem_atual		tam=8	fmt=%.01f
14 saida			tam=9	fmt=%.01f	expr=estoque-litragem_atual
15 bombas       		tam=9	fmt=%.01f
16 diferenca			tam=8	fmt=%.01f	expr=bombas-saida
22 tot_ger_saida		tam=9	fmt=%.01f	func=soma 	campo=saida	grupo=1
23 tot_ger_bomba	        tam=9	fmt=%.01f	func=soma 	campo=bombas	grupo=1
24 tot_ger_difer		tam=9	fmt=%.01f	func=soma 	campo=diferenca	grupo=1
30 data_ini			tam=10	fmt=data
31 data_fim			tam=10	fmt=data
33 tot_ite_saida_produto        tam=9	fmt=%.01f	func=soma 	campo=saida	grupo=2
34 tot_ite_bomba_produto        tam=9	fmt=%.01f	func=soma 	campo=bombas	grupo=2
35 tot_ite_difer_produto        tam=9	fmt=%.01f	func=soma 	campo=diferenca	grupo=2
36 data				tam=10	fmt=data</apelidos>
    <cab_pagina>
#1                                                                            #2
----------------------------------------------------------------------------------------------

                             MEDIÇÕES DE TANQUE - Data: #36

</cab_pagina>
    <cab_grupo nome="1" quebra="empresa">

Empresa: #3
</cab_grupo>
    <cab_grupo nome="2" quebra="empresa,combustivel,produto">
+--------------------------------------------------------------------------------------------+
| Produto: #6                                                                                |
+------+----------------+---------+---------+----------------+---------+---------+-----------+
|      |    Inicial     |         |         |     Final      |   Saida |   Saida |           |
| TQ   | Med | Litragem | Entrada | Estoque | Med | Litragem |  Bombas |  Tanque | Diferença |
+------+-----+----------+---------+---------+-----+----------+---------+---------+-----------+
</cab_grupo>
    <detalhe>
| #5   | #8  | #9       |#10      |#11      | #12 | #13      |#15      |#14      |  #16      |
</detalhe>
    <rod_grupo nome="2">
+------+-----+----------+---------+---------+-----+----------+---------+---------+-----------+
|                                Total Geral do Produto      |#34      |#33      | #35       |
+------------------------------------------------------------+---------+---------+-----------+

</rod_grupo>
    <rod_grupo nome="1">
+------------------------------------------------------------+---------+---------+-----------+
|                               Total Geral da Empresa       |#23      |#22      | #24       |
+------------------------------------------------------------+---------+---------+-----------+
</rod_grupo>
    <rod_pagina>
+------+-----+----------+---------+---------+-----+----------+---------+---------+-----------+
</rod_pagina>
    </layout>
    </relatorio>