<?xml version='1.0' encoding='iso8859-1'?>
<relatorio ts="2008-11-10 10:22:36" versao_xml="0.1"><tela titulo="Recebimentos">
  <quadro titulo="Parâmetros">
    <procura id="empresa" modelo="empresa" titulo="Empresa" valor_padrao="select grid from empresa_local" />
    <caixa>
      <campo id="data" modelo="periodo" titulo="Período" valor_padrao="select to_char(current_date, &apos;YYYY-mm-01&apos;)::date, to_char(current_date + interval &apos;1 month&apos;, &apos;YYYY-mm-01&apos;)::date - 1" />
      <campo id="turno" tipo="inteiro" titulo="Turno" />
    </caixa>
    <procura id="conta_ori" modelo="conta" titulo="Conta Origem" />
    <procura id="conta_des" modelo="conta" titulo="Conta Destino" />
    <procura id="pessoa" modelo="pessoa" titulo="Pessoa" />
    <campo id="documento" tipo="inteiro" titulo="Documento" />
  </quadro>
</tela><ajuda>Relatorio de Recebimento

Este relatório é um custom para o cliente Buffon</ajuda><layout dados="select 
    distinct t.*, 
    valor_titulo_liq as valor_titulo,
    (case when valor_titulo_liq &lt; movto_valor then (movto_valor-valor_titulo_liq) else valor_mora end) as mora,
    (case when $conta_ori is not null then &apos;Conta origem: &apos;||(select nome from conta where codigo = $conta_ori) end) as nome_conta_ori, 
    (case when $conta_des is not null then &apos;Conta destino: &apos;||(select nome from conta where codigo = $conta_des) end) as nome_conta_des, 
    coalesce(((valor_titulo_liq+(case when valor_titulo_liq &lt; movto_valor then (movto_valor-valor_titulo_liq) else valor_mora end))-saldo),0) as saldo_titulo1, 
    (case when (movto_valor-valor_titulo_liq) &lt; 0 then (case when movto_documento = boleto_documento then (desconto_valor+movto_desconto) else movto_desconto end) else 0 end) as valor_desconto,
    (case when movto_documento like &apos;%(P)&apos; then ((valor_titulo_liq+(case when valor_titulo_liq &lt; movto_valor then (movto_valor-valor_titulo_liq) else valor_mora end))-((case when (movto_valor-valor_titulo_liq) &lt;= 0 then (case when movto_documento = boleto_documento then (desconto_valor+movto_desconto) else movto_desconto end) else 0 end)+saldo)) else ((valor_titulo_liq+(case when valor_titulo_liq &lt; movto_valor then (movto_valor-valor_titulo_liq) else valor_mora end))-((case when (movto_valor-valor_titulo_liq) &lt; 0 then (case when movto_documento = boleto_documento then (desconto_valor+movto_desconto) else movto_desconto end) else 0 end)+movto_valor)) end) as saldo_titulo
from 
    (select 
        to_char(m.data,&apos;dd/mm/yy&apos;) as movto_data, 
        m.turno as movto_turno, 
        m.documento as movto_documento, 
        bi.documento as boleto_documento, 
        m.pessoa as movto_pessoa,
        m.valor as movto_valor, 
        mm.nome as motivo_nome, 
        mm.codigo as quebra, 
        (case when length(m.obs) &lt;&gt; 0 then p.nome||&apos; // &apos;||m.obs else p.nome end) as movto_pessoa_obs, 
        cdeb.nome as cdeb_nome, 
         coalesce(bi.valor,coalesce((select sum(valor) from movto where trim((string_to_array(documento,&apos;(&apos; ))[1],&apos; &apos;) = trim((string_to_array(m.documento,&apos;(&apos; ))[1],&apos; &apos;) and empresa = m.empresa and conta_debitar=m.conta_debitar and conta_creditar=m.conta_creditar),m.valor)) as valor_titulo_liq,
        coalesce((select sum(a.valor) from movto a join (select parent from movto_map where child = m.grid) gm on (a.grid=gm.parent) join motivo_movto b on (b.grid=a.motivo) where motivo = (select motivo from motivo_config where chave=&apos;DESCONTO_FATURA&apos;)),0) as movto_desconto, 
        coalesce((select sum(info::numeric) from movto_info where movto=m.grid and tipo in (&apos;juros&apos;,&apos;multa&apos;)),0)+coalesce((select sum(a.valor) from movto a join(select parent from movto_map where child = m.grid) gm on (a.grid=gm.parent) join motivo_movto b on (b.grid=a.motivo) where motivo in ((select motivo from motivo_config where chave=&apos;JUROS&apos;),(select motivo from motivo_config where chave=&apos;MULTA&apos;))),0) as valor_mora, 
        m.grid, 
        (select sum(valor)+coalesce(bi.desconto_valor,0) from movto where trim((string_to_array(documento,&apos;(&apos; ))[1],&apos; &apos;) = trim((string_to_array(m.documento,&apos;(&apos; ))[1],&apos; &apos;) and grid &lt;= m.grid and pessoa = m.pessoa and empresa=m.empresa and (conta_creditar = m.conta_creditar or conta_debitar=m.conta_debitar)) as saldo, 
        coalesce(bi.desconto_valor,(coalesce((select sum(info::numeric) from movto_info where movto=m.grid and tipo=&apos;desconto&apos;),0))) as desconto_valor,
        bi.grid as boleto_grid
    from 
        movto m 
           join motivo_movto mm on (m.motivo=mm.grid) 
              join conta ccre on (m.conta_creditar=ccre.codigo) 
              join conta cdeb on (m.conta_debitar=cdeb.codigo) 
              left join pessoa p on (m.pessoa=p.grid) 
              left join movto_info mi on (mi.movto=m.grid and mi.tipo=&apos;desconto&apos;) 
              left join boleto_info bi on (trim((string_to_array(bi.documento,&apos;(&apos; ))[1],&apos; &apos;) = trim((string_to_array(m.documento,&apos;(&apos; ))[1],&apos; &apos;) and bi.sacado = m.pessoa and bi.grid = (select max(x.grid) from boleto_info x where bi.documento=x.documento and bi.sacado=x.sacado)) 
    where 
        (case when $empresa is null then true else m.empresa = $empresa end) 
    and     m.data between $data_ini and $data_fim 
     and     (case when $turno is null then true else m.turno = $turno end) 
     and     (case when $conta_ori is null then m.conta_creditar like (select conta from conta_config where chave = &apos;VALORES A RECEBER&apos;)||&apos;.%&apos; else m.conta_creditar = $conta_ori end) 
     and     (case when $conta_des is null then (m.conta_debitar like &apos;1.1.%&apos; or m.conta_debitar like &apos;1.2.%&apos;) else m.conta_debitar = $conta_des end) 
     and     (case when $pessoa is null then true else m.pessoa = $pessoa end) 
     and     (case when $documento is null then true else m.documento like $documento||&apos;%&apos; end) 
     order by 
         mm.codigo, 
         mm.nome, 
         m.data, 
         m.turno, 
         m.documento) t" id="4926af86b780ec1532e27002f617f068" ordem=" " titulo="Motivo Movto"><apelidos>1  rel_posto_nome	tam=40
2  rel_data_hora	tam=18
3  titulo		tam=119			alinha=centro
4  movto_data		tam=8
5  movto_turno		tam=3			alinha=direita
6  movto_documento	tam=7			alinha=esquerda
7  motivo_nome		tam=40  		alinha=esquerda
8  movto_pessoa_obs	tam=38  		alinha=esquerda
9  movto_valor		tam=10	fmt=%.02f
10 cdeb_nome		tam=15
12 quebra		tam=10			alinha=direita
13 valor_desconto	tam=8	fmt=%.02f
14 mora			tam=8	fmt=%.02f
15 valor_titulo		tam=11	fmt=%.02f
17 subtotal_desconto	tam=8	fmt=%.02f	func=soma	campo=valor_desconto	grupo=1
18 subtotal_mora	tam=8	fmt=%.02f	func=soma	campo=mora		grupo=1
19 subtotal_titulo	tam=10	fmt=%.02f	func=soma	campo=valor_titulo	grupo=1
20 subtotal_pago	tam=10	fmt=%.02f	func=soma	campo=movto_valor	grupo=1
11 total_pago		tam=10	fmt=%.02f	func=soma	campo=movto_valor
16 total_titulo		tam=10  fmt=%.02f	func=soma	campo=valor_titulo
21 total_desconto	tam=8	fmt=%.02f	func=soma	campo=valor_desconto
22 total_mora		tam=8	fmt=%.02f	func=soma	campo=mora
23 data_ini		tam=10	fmt=data
24 data_fim		tam=10	fmt=data
25 nome_conta_ori	tam=130			alinha=centro
26 nome_conta_des	tam=130			alinha=centro
27 saldo_titulo		tam=12	fmt=%.02f</apelidos><cab_pagina>
#1                                                                                                               #2
----------------------------------------------------------------------------------------------------------------------------------

                                                     R E C E B I M E N T O S
                                                Periodo: #23        a #24
#25
#26

</cab_pagina>
<cab_grupo nome="1" quebra="quebra">
+-------------------------------------------------------------------------------------------------------------------------------+
| #7                                                                                                                            |
+----------+-----+--------+----------------------------------------+-------------+---------+---------+-----------+--------------+
| Emiss.   | Tur | Nr. Doc|  Pessoa / Observação                   |Vlr Titulo   | Desc.   |  Mora   | Vlr  Pago | Saldo Titulo |
+----------+-----+--------+----------------------------------------+-------------+---------+---------+-----------+--------------+
</cab_grupo>
<detalhe>
| #4       | #5  | #6     | #8                                     | #15         |#13      |#14      |#9         | #27          |
</detalhe>
<rod_grupo nome="1">
+----------+-----+--------+----------------------------------------+-------------+---------+---------+-----------+--------------+
| SubTotal                                                                       |#17      |#18      |#20        |              |
+--------------------------------------------------------------------------------+---------+---------+-----------+--------------+

</rod_grupo>

<rod_relat>
+--------------------------------------------------------------------------------+---------+---------+-----------+--------------+
| TOTAL                                                                          |#21      |#22      |#11        |              |
+--------------------------------------------------------------------------------+---------+---------+-----------+--------------+
</rod_relat>

<rod_pagina>
+-------------------------------------------------------------------------------------------------------------------------------+
</rod_pagina></layout><layout dados="select 
    distinct t.*, 
    valor_titulo_liq as valor_titulo,
    (case when valor_titulo_liq &lt; movto_valor then (movto_valor-valor_titulo_liq) else valor_mora end) as mora,
    (case when $conta_ori is not null then &apos;Conta origem: &apos;||(select nome from conta where codigo = $conta_ori) end) as nome_conta_ori, 
    (case when $conta_des is not null then &apos;Conta destino: &apos;||(select nome from conta where codigo = $conta_des) end) as nome_conta_des, 
    coalesce(((valor_titulo_liq+(case when valor_titulo_liq &lt; movto_valor then (movto_valor-valor_titulo_liq) else valor_mora end))-saldo),0) as saldo_titulo1, 
    (case when (movto_valor-valor_titulo_liq) &lt; 0 then (case when movto_documento = boleto_documento then (desconto_valor+movto_desconto) else movto_desconto end) else 0 end) as valor_desconto,
    (case when movto_documento like &apos;%(P)&apos; then ((valor_titulo_liq+(case when valor_titulo_liq &lt; movto_valor then (movto_valor-valor_titulo_liq) else valor_mora end))-((case when (movto_valor-valor_titulo_liq) &lt;= 0 then (case when movto_documento = boleto_documento then (desconto_valor+movto_desconto) else movto_desconto end) else 0 end)+saldo)) else ((valor_titulo_liq+(case when valor_titulo_liq &lt; movto_valor then (movto_valor-valor_titulo_liq) else valor_mora end))-((case when (movto_valor-valor_titulo_liq) &lt; 0 then (case when movto_documento = boleto_documento then (desconto_valor+movto_desconto) else movto_desconto end) else 0 end)+movto_valor)) end) as saldo_titulo,
    pessoa_nome(t.movto_pessoa) as pessoa_nome
from 
    (select 
        to_char(m.data,&apos;dd/mm/yy&apos;) as movto_data, 
        m.turno as movto_turno, 
        m.documento as movto_documento, 
        bi.documento as boleto_documento, 
        m.pessoa as movto_pessoa,
        m.valor as movto_valor, 
        mm.nome as motivo_nome, 
        mm.codigo as quebra, 
        m.obs as movto_obs, 
        cdeb.nome as cdeb_nome, 
         coalesce(bi.valor,coalesce((select sum(valor) from movto where trim((string_to_array(documento,&apos;(&apos; ))[1],&apos; &apos;) = trim((string_to_array(m.documento,&apos;(&apos; ))[1],&apos; &apos;) and empresa = m.empresa and conta_debitar=m.conta_debitar and conta_creditar=m.conta_creditar),m.valor)) as valor_titulo_liq,
        coalesce((select sum(a.valor) from movto a join (select parent from movto_map where child = m.grid) gm on (a.grid=gm.parent) join motivo_movto b on (b.grid=a.motivo) where motivo = (select motivo from motivo_config where chave=&apos;DESCONTO_FATURA&apos;)),0) as movto_desconto, 
        coalesce((select sum(info::numeric) from movto_info where movto=m.grid and tipo in (&apos;juros&apos;,&apos;multa&apos;)),0)+coalesce((select sum(a.valor) from movto a join(select parent from movto_map where child = m.grid) gm on (a.grid=gm.parent) join motivo_movto b on (b.grid=a.motivo) where motivo in ((select motivo from motivo_config where chave=&apos;JUROS&apos;),(select motivo from motivo_config where chave=&apos;MULTA&apos;))),0) as valor_mora, 
        m.grid, 
        (select sum(valor)+coalesce(bi.desconto_valor,0) from movto where trim((string_to_array(documento,&apos;(&apos; ))[1],&apos; &apos;) = trim((string_to_array(m.documento,&apos;(&apos; ))[1],&apos; &apos;) and grid &lt;= m.grid and pessoa = m.pessoa and empresa=m.empresa and (conta_creditar = m.conta_creditar or conta_debitar=m.conta_debitar)) as saldo, 
        coalesce(bi.desconto_valor,(coalesce((select sum(info::numeric) from movto_info where movto=m.grid and tipo=&apos;desconto&apos;),0))) as desconto_valor,
        bi.grid as boleto_grid
    from 
        movto m 
           join motivo_movto mm on (m.motivo=mm.grid) 
              join conta ccre on (m.conta_creditar=ccre.codigo) 
              join conta cdeb on (m.conta_debitar=cdeb.codigo) 
              left join pessoa p on (m.pessoa=p.grid) 
              left join movto_info mi on (mi.movto=m.grid and mi.tipo=&apos;desconto&apos;) 
              left join boleto_info bi on (trim((string_to_array(bi.documento,&apos;(&apos; ))[1],&apos; &apos;) = trim((string_to_array(m.documento,&apos;(&apos; ))[1],&apos; &apos;) and bi.sacado = m.pessoa and bi.grid = (select max(x.grid) from boleto_info x where bi.documento=x.documento and bi.sacado=x.sacado)) 
    where 
        (case when $empresa is null then true else m.empresa = $empresa end) 
    and     m.data between $data_ini and $data_fim 
     and     (case when $turno is null then true else m.turno = $turno end) 
     and     (case when $conta_ori is null then m.conta_creditar like (select conta from conta_config where chave = &apos;VALORES A RECEBER&apos;)||&apos;.%&apos; else m.conta_creditar = $conta_ori end) 
     and     (case when $conta_des is null then (m.conta_debitar like &apos;1.1.%&apos; or m.conta_debitar like &apos;1.2.%&apos;) else m.conta_debitar = $conta_des end) 
     and     (case when $pessoa is null then true else m.pessoa = $pessoa end) 
     and     (case when $documento is null then true else m.documento like $documento||&apos;%&apos; end) 
     order by 
         mm.codigo, 
         mm.nome, 
         m.data, 
         m.turno, 
         m.documento) t" id="5e029a4d29b438c912d5458cacf49523" ordem="" titulo="Pessoa"><apelidos>1  rel_posto_nome	tam=40
2  rel_data_hora	tam=18
3  titulo		tam=119			alinha=centro
4  movto_data		tam=8
5  movto_turno		tam=3			alinha=direita
6  movto_documento	tam=7			alinha=esquerda
7  motivo_nome		tam=40  		alinha=esquerda
8  movto_obs		tam=20  		alinha=esquerda
9  movto_valor		tam=10	fmt=%.02f
10 cdeb_nome		tam=15
12 quebra		tam=10			alinha=direita
13 valor_desconto	tam=8	fmt=%.02f
14 mora			tam=8	fmt=%.02f
15 valor_titulo		tam=11	fmt=%.02f
17 subtotal_desconto	tam=8	fmt=%.02f	func=soma	campo=valor_desconto	grupo=1
18 subtotal_mora	tam=8	fmt=%.02f	func=soma	campo=mora		grupo=1
19 subtotal_titulo	tam=10	fmt=%.02f	func=soma	campo=valor_titulo	grupo=1
20 subtotal_pago	tam=10	fmt=%.02f	func=soma	campo=movto_valor	grupo=1
11 total_pago		tam=10	fmt=%.02f	func=soma	campo=movto_valor
16 total_titulo		tam=10  fmt=%.02f	func=soma	campo=valor_titulo
21 total_desconto	tam=8	fmt=%.02f	func=soma	campo=valor_desconto
22 total_mora		tam=8	fmt=%.02f	func=soma	campo=mora
23 data_ini		tam=10	fmt=data
24 data_fim		tam=10	fmt=data
25 pessoa_nome		tam=65
26 nome_conta_des	tam=130			alinha=centro
27 saldo_titulo		tam=12	fmt=%.02f
28 motivo_nome		tam=13</apelidos><cab_pagina>
#1                                                                                                             #2
--------------------------------------------------------------------------------------------------------------------------------

                                                     R E C E B I M E N T O S
                                                Periodo: #23        a #24
#25
#26

</cab_pagina>
<cab_grupo nome="1" quebra="pessoa_nome">
+------------------------------------------------------------------------------------------------------------------------------+
| #25                                                                                                                          |
+----------+-----+--------+-----------------------+---------------+-------------+---------+---------+-----------+--------------+
| Emiss.   | Tur | Nr. Doc|  Observação           | Motivo        |Vlr Titulo   | Desc.   |  Mora   | Vlr  Pago | Saldo Titulo |
+----------+-----+--------+-----------------------+---------------+-------------+---------+---------+-----------+--------------+
</cab_grupo>
<detalhe>
| #4       | #5  | #6     | #8                    | #28           | #15         |#13      |#14      |#9         | #27          |
</detalhe>
<rod_grupo nome="1">
+----------+-----+--------+-------------------------+-------------+-------------+---------+---------+-----------+--------------+
| SubTotal #25                                                                  |#17      |#18      |#20        |              |
+-------------------------------------------------------------------------------+---------+---------+-----------+--------------+

</rod_grupo>

<rod_relat>
+-------------------------------------------------------------------------------+---------+---------+-----------+--------------+
| TOTAL                                                                         |#21      |#22      |#11        |              |
+-------------------------------------------------------------------------------+---------+---------+-----------+--------------+
</rod_relat>

<rod_pagina>
+------------------------------------------------------------------------------------------------------------------------------+
</rod_pagina>
</layout><layout dados="select 
    sum(m.valor) as movto_valor, 
    cdeb.nome as cdeb_nome
from 
    movto m 
       join motivo_movto mm on (m.motivo=mm.grid) 
          join conta ccre on (m.conta_creditar=ccre.codigo) 
          join conta cdeb on (m.conta_debitar=cdeb.codigo) 
          left join pessoa p on (m.pessoa=p.grid) 
          left join movto_info mi on (mi.movto=m.grid and mi.tipo=&apos;desconto&apos;) 
          left join boleto_info bi on (trim((string_to_array(bi.documento,&apos;(&apos; ))[1],&apos; &apos;) = trim((string_to_array(m.documento,&apos;(&apos; ))[1],&apos; &apos;) and bi.sacado = m.pessoa and bi.grid = (select max(x.grid) from boleto_info x where bi.documento=x.documento and bi.sacado=x.sacado)) 
where 
    (case when $empresa is null then true else m.empresa = $empresa end) 
and     m.data between $data_ini and $data_fim 
and     (case when $turno is null then true else m.turno = $turno end) 
and     (case when $conta_ori is null then m.conta_creditar like (select conta from conta_config where chave = &apos;VALORES A RECEBER&apos;)||&apos;.%&apos; else m.conta_creditar = $conta_ori end) 
and     (case when $conta_des is null then (m.conta_debitar like &apos;1.1.%&apos; or m.conta_debitar like &apos;1.2.%&apos;) else m.conta_debitar = $conta_des end) 
and     (case when $pessoa is null then true else m.pessoa = $pessoa end) 
and     (case when $documento is null then true else m.documento like $documento||&apos;%&apos; end) 
group by
    cdeb.nome
order by 
    cdeb.nome" id="f8ead402cfaba5753bf17d56731d14f2" ordem="" titulo="Motivo Movto - Sintético"><apelidos>1  rel_posto_nome	tam=40
2  rel_data_hora	tam=18
3  titulo		tam=79	alinha=centro
4  cdeb_nome		tam=51
5  movto_valor		tam=21	fmt=%.02f
6  total		tam=21	fmt=%.02f	func=soma	campo=movto_valor
23 data_ini		tam=10	fmt=data
24 data_fim		tam=10	fmt=data
26 nome_conta_des	tam=130			alinha=centro</apelidos><cab_pagina>
#1                                                             #2
-------------------------------------------------------------------------------

                            R E C E B I M E N T O S
                               S I N T É T I C O
                        Periodo: #23        a #24     

+-----------------------------------------------------------------------------+
| Conta                                               | Valor                 |
+-----------------------------------------------------------------------------+
</cab_pagina>

<detalhe>
| #4                                                  | #5                    |
</detalhe>

<rod_relat>
+-----------------------------------------------------------------------------+
| TOTAL                                               | #6                    |
+-----------------------------------------------------------------------------+
</rod_relat>

<rod_pagina>
+-----------------------------------------------------------------------------+
</rod_pagina>
</layout></relatorio>