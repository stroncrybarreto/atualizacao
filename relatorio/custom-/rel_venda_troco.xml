<?xml version='1.0' encoding='iso8859-1'?>
<relatorio ts="2008-09-09 14:29:27" versao_xml="0.1"><tela titulo="Venda com Troco">
  <quadro titulo="Parâmetros">
    <procura id="empresa" modelo="empresa" titulo="Empresa" valor_padrao="select grid from empresa_local" />
    <procura id="cliente" modelo="pessoa" titulo="Cliente" />
    <procura id="consumidor" modelo="pessoa" titulo="Consumidor" />
    <campo id="data" modelo="periodo" titulo="Período" valor_padrao="select to_char(current_date, &apos;YYYY-07-01&apos;)::date, to_char(current_date + interval &apos;1 month&apos;, &apos;YYYY-mm-01&apos;)::date - 1" />
    <selecao id="agrupar" origem="values (1,&apos;Cliente&apos;),(2,&apos;Consumidor&apos;)" requerido="sim" titulo="Agrupar" />
  </quadro>
</tela><ajuda>&lt;big&gt;&lt;b&gt;Relatorio de Venda com Troco/b&gt;&lt;/big&gt;

Este relatório permite ver o Venda com Troco</ajuda><layout dados="select 
    t.*,
    (case when $agrupar=1 then nome_cliente else coalesce(nome_consumidor,nome_cliente) end) as nome,
    (case when $agrupar=1 then &apos;Cliente&apos; else &apos;Consumidor&apos; end) as nome_cab
from
    (select 
        distinct pessoa_nome(m.empresa) as empresa_nome,
        m.hora as data, 
        m.turno, 
        m.documento, 
        m.valor as valor_venda, 
        coalesce(m1.valor,0) as valor_desconto,
        (select sum(m2.valor) from movto m2 join motivo_movto mm on (m2.motivo = mm.grid and mm.troco is false) where m2.parent = m.grid and m2.motivo not in ((select motivo from motivo_config, motivo_movto mm where motivo=mm.grid and chave = &apos;DESCONTO_VENDA&apos;),(select motivo from motivo_config, motivo_movto mm where motivo=mm.grid and chave = &apos;VENDA&apos;))) as valor_pgto, 
        pessoa_nome(m.pessoa) as nome_cliente,         
        pessoa_nome(mc.pessoa) as nome_consumidor
    from 
        movto m 
           left join movto m1 on (m1.parent = m.grid and m1.motivo = (select motivo from motivo_config, motivo_movto mm where motivo=mm.grid and chave = &apos;DESCONTO_VENDA&apos;)) 
           left join movto mc on (mc.mlid = m.mlid and mc.motivo &lt;&gt; m.motivo and mc.pessoa &lt;&gt; m.pessoa)
    where 
        m.motivo = (select motivo from motivo_config, motivo_movto mm where motivo=mm.grid and chave = &apos;VENDA&apos;)
    and     m.data between $data_ini and $data_fim 
    and     (case when $empresa is null then true else m.empresa = $empresa end)
    and     (case when $cliente is null then true else m.pessoa = $cliente end) 
    and    (case when $consumidor is null then true else coalesce(mc.pessoa,m.pessoa) = $consumidor end)) t
where
    (valor_pgto-valor_venda+valor_desconto) &gt; 0.001
order by
    empresa_nome,
    data
" id="ae1696ccc7da85d3978f9837bee335e1" ordem=" " titulo="Venda com Troco"><apelidos>1  rel_posto_nome		tam=60
2  rel_data_hora		tam=18  
3  empresa_nome			tam=45
4  data				tam=10  fmt=data
5  turno			tam=3
6  documento			tam=6
7  nome				tam=25  
8  valor_troco			tam=11	fmt=%.02f alinha=direita	expr=valor_pgto-valor_venda+valor_desconto
9  valor_venda			tam=9   fmt=%.02f alinha=direita
10 valor_desconto		tam=9   fmt=%.02f alinha=direita
11 valor_pgto			tam=10  fmt=%.02f alinha=direita
16 perc_troco			tam=7	fmt=%.02f alinha=direita	expr=valor_troco*100/valor_pgto
12 subtotal_valor_troco		tam=11	fmt=%.02f alinha=direita	func=soma campo=valor_troco	grupo=1  
13 subtotal_valor_venda		tam=9   fmt=%.02f alinha=direita 	func=soma campo=valor_venda	grupo=1
14 subtotal_valor_desconto	tam=9   fmt=%.02f alinha=direita 	func=soma campo=valor_desconto	grupo=1
15 subtotal_valor_pgto		tam=10	fmt=%.02f alinha=direita 	func=soma campo=valor_pgto	grupo=1
17 subtotal_perc_troco		tam=7	fmt=%.02f alinha=direita	expr=subtotal_valor_troco*100/subtotal_valor_pgto
18 total_valor_troco		tam=11	fmt=%.02f alinha=direita	func=soma campo=valor_troco  
19 total_valor_venda		tam=9   fmt=%.02f alinha=direita 	func=soma campo=valor_venda
20 total_valor_desconto		tam=9   fmt=%.02f alinha=direita 	func=soma campo=valor_desconto
21 total_valor_pgto		tam=10	fmt=%.02f alinha=direita 	func=soma campo=valor_pgto
22 total_perc_troco		tam=7	fmt=%.02f alinha=direita	expr=total_valor_troco*100/total_valor_pgto
23 data_ini			tam=10	fmt=data
24 data_fim			tam=10	fmt=data
25  nome_cab			tam=25</apelidos><cab_pagina>
#1                                                                                                    #2              
----------------------------------------------------------------------------------------------------------------------

                                             T R O C O   E M   V E N D A S
                                         Período de #23        até #24       
                                    
</cab_pagina>
<cab_grupo nome="1" quebra="empresa_nome">                                    
+--------------------------------------------------------------------------------------------------------------------+
| Empresa: #3                                                                                                        |
+------------+-----+--------+---------------------------+-----------+-----------+------------+-------------+---------+
|   Data     | Tur | Nr.Doc | #25                       | Vl. Venda |  Vl Desc. | Valor Pago | Valor Troco | % Troco |
+------------+-----+--------+---------------------------+-----------+-----------+------------+-------------+---------+
</cab_grupo>
<detalhe>
| #4         | #5  | #6     | #7                        | #9        | #10       | #11        | #8          | #16     |
</detalhe>

<rod_grupo nome="1">
+------------+-----+--------+---------------------------+-----------+-----------+------------+-------------+---------+
| Total #3                                              | #13       | #14       | #15        | #12         | #17     |
+-------------------------------------------------------+-----------+-----------+------------+-------------+---------+

</rod_grupo>

<rod_pagina>
+-------------------------------------------------------+-----------+-----------+------------+-------------+---------+
</rod_pagina>

<rod_relat>
+-------------------------------------------------------+-----------+-----------+------------+-------------+---------+
| Total #3                                              | #19       | #20       | #21        | #18         | #22     |
+-------------------------------------------------------+-----------+-----------+------------+-------------+---------+
</rod_relat>

<rod_pagina>
+-------------------------------------------------------+-----------+-----------+------------+-------------+---------+
</rod_pagina>
</layout></relatorio>