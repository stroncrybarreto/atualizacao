<?xml version='1.0' encoding='iso8859-1'?>
<relatorio ts="2008-12-11 16:54:48" versao_xml="0.1">
  <tela titulo="Lucro com produto">
  <quadro titulo="Parâmetros">
    <caixa>
      <campo id="data_periodo" modelo="periodo" requerido="sim" tipo="data" titulo="Período" valor_padrao="SELECT to_char(current_date, &apos;YYYY-mm-01&apos;)::date, to_char(current_date + interval &apos;1 month&apos;, &apos;YYYY-mm-01&apos;)::date - 1" />
      <campo expande="0" id="turno" tipo="inteiro" titulo="Apenas turno" />
    </caixa>
    <procura id="deposito" modelo="deposito" titulo="Depósito" />
    <procura id="grupo" modelo="grupo_produto" titulo="Grupo" />
    <procura condicao="(case when $grupo is null then true else grupo=$grupo end)" id="subgrupo" modelo="subgrupo_produto" titulo="SubGrupo" />
    <procura id="produto" modelo="produto" titulo="Produto" />
  </quadro>
  <quadro titulo="Opções">
    <selecao id="calculo_lucro" origem="VALUES (1, &apos;Baseado no valor do custo&apos;), (2, &apos;Baseado no valor da venda&apos;)" requerido="sim" titulo="Cálculo lucro" />
    <selecao id="calculo_custo" origem="VALUES (1, &apos;Geral - Calcula o custo medio baseado em toda a movimentacao do produto&apos;),                                               (2, &apos;Ultimo Custo - Inicia o calculo partindo do ultimo custo anterior o inicio do periodo&apos;),           (3, &apos;Custo Fiscal - Deduz ICMS, PIS e COFINS para calculo do preco de custo&apos;),           (4, &apos;Custo cadastrado - Utiliza o custo informado no cadastro de produtos&apos;)" requerido="sim" titulo="Cálculo do custo médio" />
    <check id="exibir_produto" titulo="Exibir produtos sem preço de custo" />
    <check id="incluir_servico" titulo="Incluir Serviços" />
    <selecao id="agrupar" origem="VALUES (1, &apos;Grupo de Produtos&apos;), (2, &apos;Tributacao&apos;)" requerido="sim" titulo="Agrupar" />
  </quadro>
</tela>
  <ajuda>&lt;big&gt;&lt;b&gt;Relatorio de Lucro com produto&lt;/b&gt;&lt;/big&gt;

Este relatório permite ver os Lucro por produto</ajuda>
  <layout dados="select g.codigo as grupo_codigo, g.nome as grupo_nome, p.codigo as produto_codigo, p.nome as produto_nome, p.grupo, l.produto, sum(quantidade) as qtde, sum(l.valor) as venda, t.tributacao, p.tributacao as tributacao_codigo, /*preco_custo_empresa_f(l.produto, %d::bigint) as produto_preco_custo,*/ t.descricao as tributacao_nome, (select sum(x.valor) from lancto x where x.operacao like &apos;E&apos; and x.produto=l.produto and x.data between $data_periodo_ini and $data_periodo_fim and x.empresa=l.empresa) as valor_compra, (select sum(y.quantidade) from lancto y where y.operacao like &apos;E&apos; and y.produto=l.produto and y.data between $data_periodo_ini and $data_periodo_fim and y.empresa=l.empresa) as qtd_compra from lancto l join produto p on (l.produto = p.grid) join grupo_produto g on (p.grupo = g.grid) left join tributacao t on (p.tributacao = t.codigo) where l.data between $data_periodo_ini and $data_periodo_fim::date + 1 and l.operacao in (&apos;V&apos;, &apos;B&apos;) and (case when $grupo is null then true else p.grupo = $grupo end) and (case when $subgrupo is null then true else p.subgrupo = $subgrupo end) and (case when $turno is null then true else l.turno = $turno end) and (case when $deposito is null then true else l.deposito = $deposito end) and (case when $produto is null then true else l.produto = $produto end) and (case when $incluir_servico = 1 then true else p.tipo!=&apos;S&apos; end) group by g.codigo, g.nome, p.codigo, p.nome, p.grupo, l.produto, t.tributacao, p.tributacao, t.descricao, l.empresa order by (case when $agrupar = 1 then p.grupo::text else p.tributacao end), (case when $agrupar = 1 then p.nome else p.grupo::text end), (case when $agrupar = 1 then p.tributacao else p.nome end) " id="4926af86b780ec1532e27002f617f068" ordem=" " titulo="Movimento Acumulado">
    <apelidos>1  rel_posto_nome	tam=60
2  rel_data_hora	tam=18
3  data_periodo_ini	tam=10	fmt=data
4  data_periodo_fim	tam=10	fmt=data
5  subtitulo		tam=119			alinha=centro
6  grupo_nome		tam=40
7  produto_codigo	tam=6
8  produto_nome		tam=35
9  qtde			tam=11	fmt=%.1f
11 venda		tam=14	fmt=%.02f
12 custo		tam=14	fmt=%.04f
13 lucro		tam=13	fmt=%.02f
14 subtotal_qtde	tam=11	fmt=%.1f				func=soma	campo=quantidade	grupo=1
15 subtotal_venda	tam=14	fmt=%.02f				func=soma	campo=venda		grupo=1
16 subtotal_custo	tam=14	fmt=%.04f				func=soma	campo=custo		grupo=1
17 subtotal_lucro	tam=13	fmt=%.02f				func=soma	campo=lucro		grupo=1
18 total_venda		tam=14	fmt=%.02f				func=soma	campo=venda		grupo=1
19 total_custo		tam=14	fmt=%.04f				func=soma	campo=custo		grupo=1
20 total_lucro		tam=13	fmt=%.02f				func=soma	campo=lucro		grupo=1
21 margem		tam=8	fmt=%.02f
22 subtotal_margem	tam=8	fmt=%.02f				func=soma	campo=margem		grupo=1
23 total_margem		tam=8	fmt=%.02f				func=soma	campo=margem		grupo=1
24 subtitulo1		tam=115			alinha=centro
25 tributacao		tam=10	fmt=%.02f	alinha=direita
26 descricao_grupo	tam=70</apelidos>
    <cab_pagina>
#1                                                                                                                  #2             
------------------------------------------------------------------------------------------------------------------------------------
   
                                             LUCRO COM PRODUTOS
#5
#24

</cab_pagina>
    <cab_grupo nome="1" quebra="grupo">
+----------------------------------------------------------------------------------------------------------------------------------+
| #26                                                                                                                              |
+--------+-------------------------------------+------------+------------+---------------+---------------+--------------+----------+
| Código | Produto                             | Tributação | Quantidade |   Valor Venda |   Valor Custo |        Lucro | Margem(*)|
+--------+-------------------------------------+------------+------------+---------------+---------------+--------------+----------+
</cab_grupo>
    <detalhe>
| #7     | #8                                  | #25        |#9          |#11            |#12            |#13           |#21     % |
</detalhe>
    <rod_grupo nome="1">
+--------+-------------------------------------+------------+------------+---------------+---------------+--------------+----------+
| SUBTOTAIS                                                 |#14         |#15            |#16            |#17           |#22     % |
+-----------------------------------------------------------+------------+---------------+---------------+--------------+----------+

</rod_grupo>
    <rod_relat>
+-----------------------------------------------------------+------------+---------------+---------------+--------------+----------+
| TOTAIS                                                    |            |#18            |#19            |#20           |#23     % |
+-----------------------------------------------------------+------------+---------------+---------------+--------------+----------+
</rod_relat>
    <rod_pagina>
+--------+--------------------------------------------------+------------+---------------+---------------+--------------+----------+
</rod_pagina>
    </layout>
    <layout dados="select g.codigo as grupo_codigo, g.nome as grupo_nome, p.codigo as produto_codigo, p.nome as produto_nome, p.grupo, l.produto, sum(quantidade) as qtde, sum(l.valor) as venda, t.tributacao, p.tributacao as tributacao_codigo, /*preco_custo_empresa_f(l.produto, %d::bigint) as produto_preco_custo,*/ t.descricao as tributacao_nome, (select sum(x.valor) from lancto x where x.operacao like &apos;E&apos; and x.produto=l.produto and x.data between $data_periodo_ini and $data_periodo_fim and x.empresa=l.empresa) as valor_compra, (select sum(y.quantidade) from lancto y where y.operacao like &apos;E&apos; and y.produto=l.produto and y.data between $data_periodo_ini and $data_periodo_fim and y.empresa=l.empresa) as qtd_compra, l.data from lancto l join produto p on (l.produto = p.grid) join grupo_produto g on (p.grupo = g.grid) left join tributacao t on (p.tributacao = t.codigo) where l.data between $data_periodo_ini and $data_periodo_fim::date + 1 and l.operacao in (&apos;V&apos;, &apos;B&apos;) and (case when $grupo is null then true else p.grupo = $grupo end) and (case when $subgrupo is null then true else p.subgrupo = $subgrupo end) and (case when $turno is null then true else l.turno = $turno end) and (case when $deposito is null then true else l.deposito = $deposito end) and (case when $produto is null then true else l.produto = $produto end) and (case when $incluir_servico = 1 then true else p.tipo!=&apos;S&apos; end) group by g.codigo, g.nome, p.codigo, p.nome, p.grupo, l.produto, t.tributacao, p.tributacao, t.descricao, l.empresa, l.data order by p.grupo, p.nome, p.tributacao " id="06215255553750a86343b5827a539811" ordem="" titulo="Movimento Dia a Dia">
    <apelidos>1  rel_posto_nome   	tam=60
2  rel_data_hora    	tam=18
3  data_ini	    	tam=10  fmt=data
4  data_fim	    	tam=10  fmt=data
5  subtitulo		tam=116 		alinha=centro
6  grupo_nome		tam=40
7  produto_nome		tam=30
8  preco_venda		tam=11  fmt=%.02f
9  preco_custo		tam=11  fmt=%.02f
10 lucro		tam=11  fmt=%.02f
11 subtotal_venda	tam=11  fmt=%.02f			func=soma	campo=preco_venda	grupo=1
12 subtotal_custo	tam=11  fmt=%.02f			func=soma	campo=preco_custo	grupo=1
13 subtotal_lucro	tam=11  fmt=%.02f			func=soma	campo=lucro		grupo=1
14 total_venda		tam=11  fmt=%.02f			func=soma	campo=preco_venda
15 total_custo		tam=11  fmt=%.02f			func=soma	campo=preco_custo				
16 total_lucro		tam=11  fmt=%.02f			func=soma	campo=lucro
17 qtde			tam=11  fmt=%.1f
18 preco_unit		tam=7   fmt=%.03f
19 subtotal_qtde	tam=11  fmt=%.1f			func=soma	campo=qtde		grupo=1
20 data			tam=10  fmt=data
21 produto_codigo   	tam=13  
22 tributacao		tam=10	fmt=%.02f%%	alinha=direita
23 descricao_grupo	tam=50</apelidos>
    <cab_pagina>
#1                                                                                                              #2              
---------------------------------------------------------------------------------------------------------------------------------
   
                                                 LUCRO COM PRODUTOS
                                          Período de #3         a #4
#5

</cab_pagina>
    <cab_grupo nome="1" quebra="grupo,data">
+---------------------------------------------------------------------------------------------------+---------------------------+
| #23                                                                                               | Data: #20                 |
+---------------+--------------------------------+------------+-------------+---------+-------------+-------------+-------------+
| Código        | Produto                        | Tributação |  Quantidade | Pr unit | Valor Venda | Valor Custo |       Lucro |
+---------------+--------------------------------+------------+-------------+---------+-------------+-------------+-------------+
</cab_grupo>
    <detalhe>
| #21           | #7                             | #22        | #17         | #18     | #8          | #9          | #10         |
</detalhe>
    <rod_grupo nome="1">
+---------------+--------------------------------+------------+-------------+---------+-------------+-------------+-------------+
| SUBTOTAIS                                                   | #19         |         | #11         | #12         | #13         |
+-------------------------------------------------------------+-------------+---------+-------------+-------------+-------------+

</rod_grupo>
    <rod_relat>
+-------------------------------------------------------------+-------------+---------+-------------+-------------+-------------+
| TOTAIS                                                      |             |         | #14         | #15         | #16         |
+-------------------------------------------------------------+-------------+---------+-------------+-------------+-------------+
</rod_relat>
    <rod_pagina>
+-------------------------------------------------------------+-------------+---------+-------------+-------------+-------------+
</rod_pagina>
    </layout>
    </relatorio>