<?xml version='1.0' encoding='iso8859-1'?>
<relatorio ts="2008-10-21 17:06:42" versao_xml="0.1"><tela titulo="Detalhamento de Faturas">
  <quadro titulo="Parâmetros">
    <procura id="empresa" modelo="empresa" titulo="Empresa" valor_padrao="select empresa from empresa_local" />
    <procura id="conta" modelo="conta" titulo="Conta" />
    <procura id="cliente" modelo="cliente" titulo="Cliente" />
    <procura id="grupo_pessoa" modelo="grupo_pessoa" titulo="Grupo" />
    <campo expande="False" id="fatura" titulo="Nr. fatura" />
    <campo id="data_emi" modelo="periodo" titulo="Emissão" />
    <campo id="data_ven" modelo="periodo" titulo="Vencimento" />
  </quadro>
  <quadro titulo="Exibir">
    <selecao id="exibir" origem="values (1,&apos;Todas&apos;),(2,&apos;Somente a receber&apos;),(3,&apos;Somente em atraso&apos;)" requerido="sim" titulo="Faturas" />
    <selecao id="resumo" origem="values (1,&apos;Normal&apos;),(2,&apos;Agrupado por pre\xe7o&apos;),(3,&apos;Agrupado por mercadoria&apos;)" requerido="sim" titulo="Exibir resumo" />
  </quadro>
</tela><ajuda /><layout dados="" id="6f42d177f05347f0efdca912dd54c7d6" ordem="" titulo="Detalhamento de Faturas"><apelidos>1  rel_posto_nome		tam=60
2  rel_data_hora		tam=18</apelidos><cab_pagina>
#1                                                                                                             #2
-------------------------------------------------------------------------------------------------------------------------------

                                          D E T A L H A M E N T O   D E   F A T U R A S 



</cab_pagina>
<detalhe>
</detalhe><layout dados="select 
    distinct m.grid as fatura_grid, 
    (m.grid||&apos;-&apos;||nota_placa) as quebra, 
    p.codigo as cliente_codigo, 
    p.nome as cliente_nome, 
    p.cpf as cliente_cpf, 
    p.obs as cliente_obs, 
    m.documento as fatura_documento, 
    m.data as fatura_data, 
    m.vencto as fatura_vencto, 
    (case when produto_tipo = &apos;C&apos; then (case when lancto_valor &gt; movto_valor then movto_valor/lancto_valor*quantidade else quantidade end) else 0 end) as litros,     
    (case when mid.info is null then 0 else mid.info::float end) as fatura_desconto,
    (case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end) as produto_valor, 
    (case when lancto_valor &gt; movto_valor then movto_valor/lancto_valor*quantidade else quantidade end) as produto_quantidade, 
    (case when produto_preco_unit &lt;&gt; preco_tabela then preco_tabela*((movto_valor/lancto_valor)*quantidade) else (case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end) end) as valor_tabela, 
    t1.*, 
    t2.*,
    (select count(*) from movto x join pessoa z on (x.pessoa=z.grid) where (case when $empresa is null then true else x.empresa=$empresa end) and (case when $conta is null then true else x.conta_debitar = $conta end) and (case when $cliente is null then true else x.pessoa = $cliente end) and (case when $grupo_pessoa is null then true else z.grupo = $grupo_pessoa end) and (case when $fatura = &apos;&apos; then true else x.documento = $fatura end) and x.data between $data_emi_ini and $data_emi_fim and (case when $data_ven_ini is null then true else x.vencto between $data_ven_ini and $data_ven_fim end) and z.grid = p.grid group by x.documento) as qtd_fatura
from 
    movto m 
       join pessoa p on (m.pessoa=p.grid) 
       left join movto_info mid on (mid.movto=m.grid and mid.tipo=&apos;desconto&apos;)
       join (select 
            m.data as nota_data, 
            m.documento as nota_documento, 
            m.valor as movto_valor, 
            m.mlid, 
            (select info from movto_info where movto=m.parent and tipo=&apos;placa&apos; limit 1) as nota_placa, 
            m.pessoa, 
            m.child 
        from 
            movto_map mp 
               join movto m on (mp.parent=m.grid) 
        where 
            m.valor &gt; 0) t2 on (t2.child = m.grid and t2.pessoa=p.grid) 
       join (select 
            p.nome as produto_nome, 
            p.tipo as produto_tipo, 
            l.quantidade, 
            (case when l.preco_unit is null then 0 else l.preco_unit end) as produto_preco_unit, 
            (case when l.preco_unit is null then 0 else l.preco_unit end) as preco_prazo, 
            fl.preco_unit_desconto as preco_tabela, 
            l.valor as lancto_valor, 
            l.mlid, 
            l.pessoa 
        from 
            lancto l 
               join produto p on (l.produto=p.grid) 
               left join fatura_lancto fl on (l.grid=fl.lancto)) as t1 on (t1.mlid=t2.mlid and t1.pessoa=p.grid) 
where 
     $resumo = 1
and     (case when $empresa is null then true else m.empresa=$empresa end)
and     (case when $conta is null then true else m.conta_debitar = $conta end)
and     (case when $cliente is null then true else m.pessoa = $cliente end)
and     (case when $grupo_pessoa is null then true else p.grupo = $grupo_pessoa end)
and     (case when $fatura = &apos;&apos; then true else m.documento = $fatura end)
and     m.data between $data_emi_ini and $data_emi_fim
and     (case when $data_ven_ini is null then true else m.vencto between $data_ven_ini and $data_ven_fim end)
order by 
    p.nome, 
    m.data" id="c83b538523cf9db4619aa5caf8375b7c" ordem="" titulo="Normal"><apelidos>3  cliente_codigo	tam=6
4  cliente_nome		tam=40
5  cliente_cpf		tam=18
6  fatura_documento	tam=8
7  fatura_data		tam=10	fmt=data
8  fatura_vencto	tam=10	fmt=data
9  nota_documento	tam=6
10 nota_data		tam=10	fmt=data
11 nota_placa		tam=8
12 produto_quantidade	tam=7	fmt=%.02f
13 nota_km_ini		tam=8	fmt=%.01f
14 nota_km_fim		tam=8	fmt=%.01f
15 nota_km_litro	tam=5	fmt=%.01f
16 produto_nome		tam=20
17 produto_valor	tam=10	fmt=%.02f
18 placa_litros		tam=13	fmt=%.02f	func=soma	campo=litros		grupo=2
19 placa_km_litro	tam=5	fmt=%.01f
20 placa_valor		tam=11	fmt=%.02f	func=soma	campo=produto_valor	grupo=2
21 fatura_litros	tam=8	fmt=%.02f	func=soma	campo=litros		grupo=1
22 total_valor		tam=11	fmt=%.02f	func=soma	campo=produto_valor	grupo=1
23 produto_preco_unit	tam=8	fmt=%.03f
24 valor_tabela		tam=9	fmt=%.02f
25 preco_tabela		tam=8   fmt=%.03f
26 subtotal_tabela	tam=11  fmt=%.02f	func=soma	campo=valor_tabela	grupo=2
27 total_tabela		tam=11  fmt=%.02f	func=soma	campo=valor_tabela	grupo=1
28 cliente_obs		tam=29
29 fatura_desconto	tam=10  fmt=%.02f
30 qtd_fatura		tam=10  fmt=%d alinha=esquerda</apelidos><cab_relat>
</cab_relat>
<cab_grupo nome="1" quebra="fatura_grid">
+-----------------------------------------------------------------------------------------------------------------------------+
| Numero de faturas: #30                                                                                                      |
+-----------------------------------------------------------------------------------------------------------------------------+	

+-----------------------------------------------------------------------------------------------------------------------------+
| Cliente...: #3     - #4                                                             CPF/CNPJ: #5                            |
| Fatura nr.: #6       Emissao: #7            Vencto: #8                              Obs.....: #28                           |
+-----------------------------------------------------------------------------------------------------------------------------+
| N.Nota  Dt Emissao Placa       Qtde  Km Inic. Km final Km/Lt  Produto              Pr. Unit    Vl. Item   Pr. Tab  Vl. Tab. |
+-----------------------------------------------------------------------------------------------------------------------------+
</cab_grupo>

<cab_grupo nome="2" quebra="quebra">
</cab_grupo>

<detalhe>
| #9      #10        #11      #12      #13      #14      #15    #16                  #23       #17         #25      #24       |
</detalhe>

<rod_grupo nome="2">
| Subtotal litr. comb.: #18                                                    Subtotal...:   #20                 #26         |
|                                                                                                                             |
</rod_grupo>

<rod_grupo nome="1">
+-----------------------------------------------------------------------------------------------------------------------------+
| Total litros combustivel..:#21                Valor total Desc.: #29          Valor total:  #22                 #27         |
+-----------------------------------------------------------------------------------------------------------------------------+

</rod_grupo>
<rod_relat>
</rod_relat>
<rod_pagina>
+-----------------------------------------------------------------------------------------------------------------------------+
</rod_pagina></layout><layout dados="select
    produto_nome,
    cliente_nome,
    sum(quantidade) as total_quantidade,
    sum(valor) as total_valor,
    sum(valor_tabelado) as total_valor_tabelado
from
(select 
    distinct produto_nome,
    p.nome as cliente_nome,
    ((case when lancto_valor &gt; movto_valor then movto_valor/lancto_valor*quantidade else quantidade end)) as quantidade,
    ((case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end)) as valor,
    ((case when produto_preco_unit &lt;&gt; preco_tabela then preco_tabela*((movto_valor/lancto_valor)*quantidade) else (case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end) end)) as valor_tabelado    
from 
    movto m 
       join pessoa p on (m.pessoa=p.grid) 
       join (select 
            m.valor as movto_valor, 
            m.mlid, 
            m.pessoa, 
            m.child 
        from 
            movto_map mp 
               join movto m on (mp.parent=m.grid) 
        where 
            m.valor &gt; 0) t2 on (t2.child = m.grid and t2.pessoa=p.grid) 
       join (select 
            p.nome as produto_nome, 
            p.tipo as produto_tipo, 
            l.quantidade, 
            (case when l.preco_unit is null then 0 else l.preco_unit end) as produto_preco_unit, 
            fl.preco_unit_desconto as preco_tabela, 
            l.valor as lancto_valor, 
            l.mlid, 
            l.pessoa 
        from 
            lancto l 
               join produto p on (l.produto=p.grid) 
               left join fatura_lancto fl on (l.grid=fl.lancto)) as t1 on (t1.mlid=t2.mlid and t1.pessoa=p.grid) 
where 
     $resumo = 1
and     (case when $empresa is null then true else m.empresa=$empresa end)
and     (case when $conta is null then true else m.conta_debitar = $conta end)
and     (case when $cliente is null then true else m.pessoa = $cliente end)
and     (case when $grupo_pessoa is null then true else p.grupo = $grupo_pessoa end)
and     (case when $fatura = &apos;&apos; then true else m.documento = $fatura end)
and     m.data between $data_emi_ini and $data_emi_fim
and     (case when $data_ven_ini is null then true else m.vencto between $data_ven_ini and $data_ven_fim end)) t
group by
    2,1
order by
    2,1" id="dd1d44e9d57325895d7ca4cb984b0002" ordem="" titulo="Resumo Normal"><apelidos>1  produto_nome		tam=30
2  total_quantidade	tam=12	fmt=%.02f
3  total_valor		tam=15	fmt=%.02f
4  cliente_nome         tam=60
5  total_valor_tabelado	tam=15	fmt=%.02f</apelidos><cab_relat>
</cab_relat>

<cab_grupo nome="1" quebra="cliente_nome">
+----------------------------------------------------------------------------------+ 
| Resumo cliente: #4                                                               |
+--------------------------------+-------------+-----------------+-----------------+  
| Descrição                      | Quantidade  |      Valor      |    Valor Tabela |
+--------------------------------+-------------+-----------------+-----------------+
</cab_grupo>

<detalhe>
| #1                             |#2           | #3              | #5              |
</detalhe>

<rod_grupo nome="1">
+--------------------------------+-------------+-----------------+-----------------+

</rod_grupo>

<rod_relat>
</rod_relat>
<rod_pagina>
+--------------------------------+-------------+-----------------+-----------------+
</rod_pagina></layout><layout dados="select 
    distinct m.grid as fatura_grid, 
    (m.grid||&apos;-&apos;||produto_preco_unit) as quebra, 
    p.codigo as cliente_codigo, 
    p.nome as cliente_nome, 
    p.cpf as cliente_cpf, 
    p.obs as cliente_obs, 
    m.documento as fatura_documento, 
    m.data as fatura_data, 
    m.vencto as fatura_vencto, 
    (case when produto_tipo = &apos;C&apos; then (case when lancto_valor &gt; movto_valor then movto_valor/lancto_valor*quantidade else quantidade end) else 0 end) as litros,     
    (case when mid.info is null then 0 else mid.info::float end) as fatura_desconto,
    (case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end) as produto_valor, 
    (case when lancto_valor &gt; movto_valor then movto_valor/lancto_valor*quantidade else quantidade end) as produto_quantidade, 
    (case when produto_preco_unit &lt;&gt; preco_tabela then preco_tabela*((movto_valor/lancto_valor)*quantidade) else (case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end) end) as valor_tabela, 
    t1.*, 
    t2.*,
    (select count(*) from movto x join pessoa z on (x.pessoa=z.grid) where (case when $empresa is null then true else x.empresa=$empresa end) and (case when $conta is null then true else x.conta_debitar = $conta end) and (case when $cliente is null then true else x.pessoa = $cliente end) and (case when $grupo_pessoa is null then true else z.grupo = $grupo_pessoa end) and (case when $fatura = &apos;&apos; then true else x.documento = $fatura end) and x.data between $data_emi_ini and $data_emi_fim and (case when $data_ven_ini is null then true else x.vencto between $data_ven_ini and $data_ven_fim end) and z.grid = p.grid group by x.documento) as qtd_fatura
from 
    movto m 
       join pessoa p on (m.pessoa=p.grid) 
       left join movto_info mid on (mid.movto=m.grid and mid.tipo=&apos;desconto&apos;)
       join (select 
            m.data as nota_data, 
            m.documento as nota_documento, 
            m.valor as movto_valor, 
            m.mlid, 
            (select info from movto_info where movto=m.parent and tipo=&apos;placa&apos; limit 1) as nota_placa, 
            m.pessoa, 
            m.child 
        from 
            movto_map mp 
               join movto m on (mp.parent=m.grid) 
        where 
            m.valor &gt; 0) t2 on (t2.child = m.grid and t2.pessoa=p.grid) 
       join (select 
            p.nome as produto_nome, 
            p.tipo as produto_tipo, 
            l.quantidade, 
            (case when l.preco_unit is null then 0 else l.preco_unit end) as produto_preco_unit, 
            (case when l.preco_unit is null then 0 else l.preco_unit end) as preco_prazo, 
            fl.preco_unit_desconto as preco_tabela, 
            l.valor as lancto_valor, 
            l.mlid, 
            l.pessoa 
        from 
            lancto l 
               join produto p on (l.produto=p.grid) 
               left join fatura_lancto fl on (l.grid=fl.lancto)) as t1 on (t1.mlid=t2.mlid and t1.pessoa=p.grid) 
where 
     $resumo = 2
and     (case when $empresa is null then true else m.empresa=$empresa end)
and     (case when $conta is null then true else m.conta_debitar = $conta end)
and     (case when $cliente is null then true else m.pessoa = $cliente end)
and     (case when $grupo_pessoa is null then true else p.grupo = $grupo_pessoa end)
and     (case when $fatura = &apos;&apos; then true else m.documento = $fatura end)
and     m.data between $data_emi_ini and $data_emi_fim
and     (case when $data_ven_ini is null then true else m.vencto between $data_ven_ini and $data_ven_fim end)
order by 
    p.nome, 
    m.data" id="eb8e25cfb008f4054081e40adbe6f5b6" ordem="" titulo="Agrupado Por Preço"><apelidos>3  cliente_codigo	tam=6
4  cliente_nome		tam=40
5  cliente_cpf		tam=18
6  fatura_documento	tam=8
7  fatura_data		tam=10	fmt=data
8  fatura_vencto	tam=10	fmt=data
9  nota_documento	tam=6
10 nota_data		tam=10	fmt=data
11 nota_placa		tam=8
12 produto_quantidade	tam=7	fmt=%.02f
13 nota_km_ini		tam=8	fmt=%.01f
14 nota_km_fim		tam=8	fmt=%.01f
15 nota_km_litro	tam=5	fmt=%.01f
16 produto_nome		tam=20
17 produto_valor	tam=10	fmt=%.02f
18 placa_litros		tam=13	fmt=%.02f	func=soma	campo=litros		grupo=2
19 placa_km_litro	tam=5	fmt=%.01f
20 placa_valor		tam=11	fmt=%.02f	func=soma	campo=produto_valor	grupo=2
21 fatura_litros	tam=8	fmt=%.02f	func=soma	campo=litros		grupo=1
22 total_valor		tam=11	fmt=%.02f	func=soma	campo=produto_valor	grupo=1
23 produto_preco_unit	tam=8	fmt=%.03f
24 valor_tabela		tam=9	fmt=%.02f
25 preco_tabela		tam=8   fmt=%.03f
26 subtotal_tabela	tam=11  fmt=%.02f	func=soma	campo=valor_tabela	grupo=2
27 total_tabela		tam=11  fmt=%.02f	func=soma	campo=valor_tabela	grupo=1
28 cliente_obs		tam=29
29 fatura_desconto	tam=10  fmt=%.02f
30 qtd_fatura		tam=10  fmt=%d alinha=esquerda</apelidos><cab_relat>
</cab_relat>
<cab_grupo nome="1" quebra="fatura_grid">
+-----------------------------------------------------------------------------------------------------------------------------+
| Numero de faturas: #30                                                                                                      |
+-----------------------------------------------------------------------------------------------------------------------------+	

+-----------------------------------------------------------------------------------------------------------------------------+
| Cliente...: #3     - #4                                                             CPF/CNPJ: #5                            |
| Fatura nr.: #6       Emissao: #7            Vencto: #8                              Obs.....: #28                           |
+-----------------------------------------------------------------------------------------------------------------------------+
| N.Nota  Dt Emissao Placa       Qtde  Km Inic. Km final Km/Lt  Produto              Pr. Unit    Vl. Item   Pr. Tab  Vl. Tab. |
+-----------------------------------------------------------------------------------------------------------------------------+
</cab_grupo>

<cab_grupo nome="2" quebra="quebra">
</cab_grupo>

<detalhe>
| #9      #10        #11      #12      #13      #14      #15    #16                  #23       #17         #25      #24       |
</detalhe>

<rod_grupo nome="2">
| Subtotal placa litros comb.: #18                                      Subtotal valor: #20                Tabela:#26         |
|                                                                                                                             |
</rod_grupo>

<rod_grupo nome="1">
+-----------------------------------------------------------------------------------------------------------------------------+
| Total litros combustivel...: #21                                      Valor total...: #22                Tabela:#27         |
+-----------------------------------------------------------------------------------------------------------------------------+

</rod_grupo>
<rod_relat>
</rod_relat>
<rod_pagina>
+-----------------------------------------------------------------------------------------------------------------------------+
</rod_pagina>
</layout><layout dados="select
    produto_nome,
    cliente_nome,
    produto_preco_unit,
    sum(quantidade) as total_quantidade,
    sum(valor) as total_valor,
    sum(valor_tabelado) as total_valor_tabelado,
    produto_preco_unit
from
(select 
    distinct produto_nome,
    p.nome as cliente_nome,
    ((case when lancto_valor &gt; movto_valor then movto_valor/lancto_valor*quantidade else quantidade end)) as quantidade,
    ((case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end)) as valor,
    ((case when produto_preco_unit &lt;&gt; preco_tabela then preco_tabela*((movto_valor/lancto_valor)*quantidade) else (case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end) end)) as valor_tabelado,
    produto_preco_unit
from 
    movto m 
       join pessoa p on (m.pessoa=p.grid) 
       join (select 
            m.valor as movto_valor, 
            m.mlid, 
            m.pessoa, 
            m.child 
        from 
            movto_map mp 
               join movto m on (mp.parent=m.grid) 
        where 
            m.valor &gt; 0) t2 on (t2.child = m.grid and t2.pessoa=p.grid) 
       join (select 
            p.nome as produto_nome, 
            p.tipo as produto_tipo, 
            l.quantidade, 
            (case when l.preco_unit is null then 0 else l.preco_unit end) as produto_preco_unit, 
            fl.preco_unit_desconto as preco_tabela, 
            l.valor as lancto_valor, 
            l.mlid, 
            l.pessoa 
        from 
            lancto l 
               join produto p on (l.produto=p.grid) 
               left join fatura_lancto fl on (l.grid=fl.lancto)) as t1 on (t1.mlid=t2.mlid and t1.pessoa=p.grid) 
where 
     $resumo = 2
and     (case when $empresa is null then true else m.empresa=$empresa end)
and     (case when $conta is null then true else m.conta_debitar = $conta end)
and     (case when $cliente is null then true else m.pessoa = $cliente end)
and     (case when $grupo_pessoa is null then true else p.grupo = $grupo_pessoa end)
and     (case when $fatura = &apos;&apos; then true else m.documento = $fatura end)
and     m.data between $data_emi_ini and $data_emi_fim
and     (case when $data_ven_ini is null then true else m.vencto between $data_ven_ini and $data_ven_fim end)) t
group by
    2,1,3
order by
    2,3,1" id="867623f151db37c13c515bacdc31ba61" ordem="" titulo="Resumo Agrupado Por Preço"><apelidos>1  produto_nome		tam=30
2  total_quantidade	tam=12	fmt=%.02f
3  total_valor		tam=15	fmt=%.02f
4  cliente_nome         tam=60
5  total_valor_tabelado	tam=15	fmt=%.02f
6  produto_preco_unit	tam=10  fmt=%.02f</apelidos><cab_relat>
</cab_relat>

<cab_grupo nome="1" quebra="cliente_nome">
+-----------------------------------------------------------------------------------------------+ 
| Resumo cliente: #4                                                                            |
+--------------------------------+------------+-------------+-----------------+-----------------+
| Descrição                      | Preco Unit | Quantidade  |      Valor      | Valor Tabelado  |
+--------------------------------+------------+-------------+-----------------+-----------------+
</cab_grupo>

<detalhe>
| #1                             | #6         | #2          | #3              | #5              |
</detalhe>

<rod_grupo nome="1">
+--------------------------------+------------+-------------+-----------------+-----------------+  

</rod_grupo>

<rod_relat>
</rod_relat>
<rod_pagina>
+--------------------------------+------------+-------------+-----------------+-----------------+  
</rod_pagina></layout><layout dados="select 
    distinct m.grid as fatura_grid, 
    (m.grid||&apos;-&apos;||produto_tipo) as quebra, 
    p.codigo as cliente_codigo, 
    p.nome as cliente_nome, 
    p.cpf as cliente_cpf, 
    p.obs as cliente_obs, 
    m.documento as fatura_documento, 
    m.data as fatura_data, 
    m.vencto as fatura_vencto, 
    (case when produto_tipo = &apos;C&apos; then (case when lancto_valor &gt; movto_valor then movto_valor/lancto_valor*quantidade else quantidade end) else 0 end) as litros,     
    (case when mid.info is null then 0 else mid.info::float end) as fatura_desconto,
    (case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end) as produto_valor, 
    (case when lancto_valor &gt; movto_valor then movto_valor/lancto_valor*quantidade else quantidade end) as produto_quantidade, 
    (case when produto_preco_unit &lt;&gt; preco_tabela then preco_tabela*((movto_valor/lancto_valor)*quantidade) else (case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end) end) as valor_tabela, 
    t1.*, 
    t2.*,
    (select count(*) from movto x join pessoa z on (x.pessoa=z.grid) where (case when $empresa is null then true else x.empresa=$empresa end) and (case when $conta is null then true else x.conta_debitar = $conta end) and (case when $cliente is null then true else x.pessoa = $cliente end) and (case when $grupo_pessoa is null then true else z.grupo = $grupo_pessoa end) and (case when $fatura = &apos;&apos; then true else x.documento = $fatura end) and x.data between $data_emi_ini and $data_emi_fim and (case when $data_ven_ini is null then true else x.vencto between $data_ven_ini and $data_ven_fim end) and z.grid = p.grid group by x.documento) as qtd_fatura
from 
    movto m 
       join pessoa p on (m.pessoa=p.grid) 
       left join movto_info mid on (mid.movto=m.grid and mid.tipo=&apos;desconto&apos;)
       join (select 
            m.data as nota_data, 
            m.documento as nota_documento, 
            m.valor as movto_valor, 
            m.mlid, 
            (select info from movto_info where movto=m.parent and tipo=&apos;placa&apos; limit 1) as nota_placa, 
            m.pessoa, 
            m.child 
        from 
            movto_map mp 
               join movto m on (mp.parent=m.grid) 
        where 
            m.valor &gt; 0) t2 on (t2.child = m.grid and t2.pessoa=p.grid) 
       join (select 
            p.nome as produto_nome, 
            p.tipo as produto_tipo, 
            l.quantidade, 
            (case when l.preco_unit is null then 0 else l.preco_unit end) as produto_preco_unit, 
            (case when l.preco_unit is null then 0 else l.preco_unit end) as preco_prazo, 
            fl.preco_unit_desconto as preco_tabela, 
            l.valor as lancto_valor, 
            l.mlid, 
            l.pessoa 
        from 
            lancto l 
               join produto p on (l.produto=p.grid) 
               left join fatura_lancto fl on (l.grid=fl.lancto)) as t1 on (t1.mlid=t2.mlid and t1.pessoa=p.grid) 
where 
     $resumo = 3
and     (case when $empresa is null then true else m.empresa=$empresa end)
and     (case when $conta is null then true else m.conta_debitar = $conta end)
and     (case when $cliente is null then true else m.pessoa = $cliente end)
and     (case when $grupo_pessoa is null then true else p.grupo = $grupo_pessoa end)
and     (case when $fatura = &apos;&apos; then true else m.documento = $fatura end)
and     m.data between $data_emi_ini and $data_emi_fim
and     (case when $data_ven_ini is null then true else m.vencto between $data_ven_ini and $data_ven_fim end)
order by 
    p.nome, 
    m.data" id="1ae914112c8c5370cc259c13ae1e3013" ordem="" titulo="Agrupado Por Mercadoria"><apelidos>3  cliente_codigo	tam=6
4  cliente_nome		tam=40
5  cliente_cpf		tam=18
6  fatura_documento	tam=8
7  fatura_data		tam=10	fmt=data
8  fatura_vencto	tam=10	fmt=data
9  nota_documento	tam=6
10 nota_data		tam=10	fmt=data
11 nota_placa		tam=8
12 produto_quantidade	tam=7	fmt=%.02f
13 nota_km_ini		tam=8	fmt=%.01f
14 nota_km_fim		tam=8	fmt=%.01f
15 nota_km_litro	tam=5	fmt=%.01f
16 produto_nome		tam=25
17 produto_valor	tam=10	fmt=%.02f
18 placa_litros		tam=13	fmt=%.02f	func=soma	campo=litros		grupo=2
19 placa_km_litro	tam=5	fmt=%.01f
20 placa_valor		tam=11	fmt=%.02f	func=soma	campo=produto_valor	grupo=2
21 fatura_litros	tam=8	fmt=%.02f	func=soma	campo=litros		grupo=1
22 total_valor		tam=11	fmt=%.02f	func=soma	campo=produto_valor	grupo=1
23 produto_preco_unit	tam=8	fmt=%.03f
24 valor_tabela		tam=9	fmt=%.02f
25 preco_tabela		tam=8   fmt=%.03f
26 subtotal_tabela	tam=11  fmt=%.02f	func=soma	campo=valor_tabela	grupo=2
27 total_tabela		tam=11  fmt=%.02f	func=soma	campo=valor_tabela	grupo=1
28 cliente_obs		tam=29
29 fatura_desconto	tam=10  fmt=%.02f
30 qtd_fatura		tam=10  fmt=%d 		alinha=esquerda</apelidos><cab_relat>
</cab_relat>
<cab_grupo nome="1" quebra="fatura_grid">
+-----------------------------------------------------------------------------------------------------------------------------+
| Numero de faturas: #30                                                                                                      |
+-----------------------------------------------------------------------------------------------------------------------------+	

+-----------------------------------------------------------------------------------------------------------------------------+
| Cliente...: #3     - #4                                                             CPF/CNPJ: #5                            |
| Fatura nr.: #6       Emissao: #7            Vencto: #8                                                                      |
+-----------------------------------------------------------------------------------------------------------------------------+
| N.Nota  Dt Emissao Placa       Qtde  Km Inic. Km final Km/Lt  Produto              Pr. Unit    Vl. Item   Pr. Tab  Vl. Tab. |
+-----------------------------------------------------------------------------------------------------------------------------+
</cab_grupo>

<cab_grupo nome="2" quebra="quebra">
</cab_grupo>

<detalhe>
| #9      #10        #11      #12      #13      #14      #15    #16                  #23       #17         #25      #24       |
</detalhe>

<rod_grupo nome="2">
| Subtotal placa quantidade:  #18                                       Subtotal valor: #20                Tabela:#26         |
|                                                                                                                             |
</rod_grupo>

<rod_grupo nome="1">
+-----------------------------------------------------------------------------------------------------------------------------+
| Total quantidade produto...: #21                                      Valor total...: #22                Tabela:#27         |
+-----------------------------------------------------------------------------------------------------------------------------+

</rod_grupo>
<rod_relat>
</rod_relat>
<rod_pagina>
+-----------------------------------------------------------------------------------------------------------------------------+
</rod_pagina>
</layout><layout dados="select
    produto_nome,
    cliente_nome,
    produto_preco_unit,
    sum(quantidade) as total_quantidade,
    sum(valor) as total_valor,
    sum(valor_tabelado) as total_valor_tabelado,
    produto_preco_unit
from
(select 
    distinct produto_nome,
    p.nome as cliente_nome,
    ((case when lancto_valor &gt; movto_valor then movto_valor/lancto_valor*quantidade else quantidade end)) as quantidade,
    ((case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end)) as valor,
    ((case when produto_preco_unit &lt;&gt; preco_tabela then preco_tabela*((movto_valor/lancto_valor)*quantidade) else (case when lancto_valor &gt; movto_valor then movto_valor else lancto_valor end) end)) as valor_tabelado,
    produto_preco_unit
from 
    movto m 
       join pessoa p on (m.pessoa=p.grid) 
       join (select 
            m.valor as movto_valor, 
            m.mlid, 
            m.pessoa, 
            m.child 
        from 
            movto_map mp 
               join movto m on (mp.parent=m.grid) 
        where 
            m.valor &gt; 0) t2 on (t2.child = m.grid and t2.pessoa=p.grid) 
       join (select 
            p.nome as produto_nome, 
            p.tipo as produto_tipo, 
            l.quantidade, 
            (case when l.preco_unit is null then 0 else l.preco_unit end) as produto_preco_unit, 
            fl.preco_unit_desconto as preco_tabela, 
            l.valor as lancto_valor, 
            l.mlid, 
            l.pessoa 
        from 
            lancto l 
               join produto p on (l.produto=p.grid) 
               left join fatura_lancto fl on (l.grid=fl.lancto)) as t1 on (t1.mlid=t2.mlid and t1.pessoa=p.grid) 
where 
     $resumo = 3
and     (case when $empresa is null then true else m.empresa=$empresa end)
and     (case when $conta is null then true else m.conta_debitar = $conta end)
and     (case when $cliente is null then true else m.pessoa = $cliente end)
and     (case when $grupo_pessoa is null then true else p.grupo = $grupo_pessoa end)
and     (case when $fatura = &apos;&apos; then true else m.documento = $fatura end)
and     m.data between $data_emi_ini and $data_emi_fim
and     (case when $data_ven_ini is null then true else m.vencto between $data_ven_ini and $data_ven_fim end)) t
group by
    2,1,3
order by
    2,3,1" id="c328c15e144aaba0204ce51ce26b6534" ordem="" titulo="Resumo Agrupado Por Mercadoria"><apelidos>1  produto_nome		tam=30
2  total_quantidade	tam=12	fmt=%.02f
3  total_valor		tam=15	fmt=%.02f
4  cliente_nome         tam=60
5  total_valor_tabelado	tam=15	fmt=%.02f
6  produto_preco_unit	tam=10  fmt=%.02f</apelidos><cab_relat>
</cab_relat>

<cab_grupo nome="1" quebra="cliente_nome">
+-----------------------------------------------------------------------------------------------+ 
| Resumo cliente: #4                                                                            |
+--------------------------------+------------+-------------+-----------------+-----------------+
| Descrição                      | Preco Unit | Quantidade  |      Valor      | Valor Tabelado  |
+--------------------------------+------------+-------------+-----------------+-----------------+
</cab_grupo>

<detalhe>
| #1                             | #6         | #2          | #3              | #5              |
</detalhe>

<rod_grupo nome="1">
+--------------------------------+------------+-------------+-----------------+-----------------+  

</rod_grupo>

<rod_relat>
</rod_relat>
<rod_pagina>
+--------------------------------+------------+-------------+-----------------+-----------------+  
</rod_pagina></layout></layout></relatorio>